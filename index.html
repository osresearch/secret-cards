<html>
<head>
<script src="util.js"></script>
<script src="sha256.js"></script>
<script src="sra.js"></script>
<script src="cards.js"></script>
<script src="cardtable.js"></script>
<script src="webrtc.js"></script>
<style>
.reveal-button, .discard-button {
	display: block;
	position: absolute;
	left: 0px;
	width: 64px;
	height: 32px;
	color: #ffffff00;
	font-size: 16px;
}

.reveal-button { top:0px; }
.discard-button { top:40px; }

.reveal-button:hover, .discard-button:hover {
	background: #800040a0;
	color:#000;
}

.suite-1, .suite-2 {
	position: relative;
	color: red;
}
.suite-0, .suite-3 {
	position: relative;
	color: blue;
}
</style>
</head>
<body>
<script>
const cards =
"ðŸ‚¡ðŸ‚¢ðŸ‚£ðŸ‚¤ðŸ‚¥ðŸ‚¦ðŸ‚§ðŸ‚¨ðŸ‚©ðŸ‚ªðŸ‚«ðŸ‚­ðŸ‚®"+
"ðŸ‚±ðŸ‚²ðŸ‚³ðŸ‚´ðŸ‚µðŸ‚¶ðŸ‚·ðŸ‚¸ðŸ‚¹ðŸ‚ºðŸ‚»ðŸ‚½ðŸ‚¾"+
"ðŸƒðŸƒ‚ðŸƒƒðŸƒ„ðŸƒ…ðŸƒ†ðŸƒ‡ðŸƒˆðŸƒ‰ðŸƒŠðŸƒ‹ðŸƒðŸƒŽ"+
"ðŸƒ‘ðŸƒ’ðŸƒ“ðŸƒ”ðŸƒ•ðŸƒ–ðŸƒ—ðŸƒ˜ðŸƒ™ðŸƒšðŸƒ›ðŸƒðŸƒž";
const num_cards = cards.length/2; // two-byte characters
const default_card = "ðŸ‚ ";
let cardtable = null;
let is_dealer = false;

function add_card(id, card)
{
	let new_card = document.createElement('div');

	if (card.card == undefined)
	{
		new_card.innerHTML = default_card;
	} else {
		let card_num = Number(card.card);
		let suite = Math.floor(card_num / 13);

		new_card.innerHTML = cards.substr(card_num*2, 2);

		new_card.setAttribute('class', 'suite-' + suite);
		let style = '';

		if (card.revealed)
		{
			style += 'background:lightgray;';
		} else {
			// add a "reveal" button at the bottom of the card
			let reveal_button = document.createElement('div');
			reveal_button.setAttribute("class", "reveal-button");
			reveal_button.onclick = () => {
				if (!card.revealed)
					n.channel.send(cardtable.reveal(card));
				display_update();
			};

			reveal_button.innerHTML = "REVEAL";
			new_card.appendChild(reveal_button);
		}

		// add a "discard" button at the bottom of the card
		let discard_button = document.createElement('div');
		discard_button.setAttribute("class", "discard-button");
		discard_button.onclick = () => {
			n.channel.send(cardtable.discard(card));
			display_update();
		};

		discard_button.innerHTML = "DISCARD";
		new_card.appendChild(discard_button);

		new_card.oncontextmenu = () => {
			n.channel.send(cardtable.discard(card));
			display_update();
		};

		new_card.setAttribute('style', style);

	}

	document.getElementById(id).appendChild(new_card);
}

function display_update()
{
	document.getElementById("dealer").innerHTML = "";
	document.getElementById("player").innerHTML = "";
	document.getElementById("deck").innerHTML = "";
	document.getElementById("table").innerHTML = "";
	document.getElementById("discard").innerHTML = "";

	if (!cardtable || !cardtable.deck || !cardtable.deck.deck)
		return;

	for(let c of cardtable.deck.deck)
	{
		let div = c.played ? c.played : "deck";
		add_card(div, c);
	}
}


// if the URL does not have a webrtc offer, then we are
// the dealer and can setup the data chanell

const url_params = new URLSearchParams(window.location.search);
const is_webrtc_initiator = !url_params.has("webrtc_offer");

if (is_webrtc_initiator)
{
	n = new DataChannel();
	is_dealer = true;
	cardtable = new CardTable(num_cards, is_dealer);

	n.offer_ready = (offer) => {
		document.getElementById("webrtc-link").innerHTML = "<a href=" + document.location + "?webrtc_offer=" + offer + ">Link for other player</a>";

		let answer = document.getElementById('webrtc-answer');

		answer.addEventListener("keyup", event => {
			if(event.key !== "Enter")
				return;
			n.accept(answer.value);
			event.preventDefault();
		});
	};

	n.onopen = () => {
		// when the other side connects, hide the webrtc gui
		document.getElementById("webrtc-ui").setAttribute("style", "display:none");
		document.getElementById("game-ui").setAttribute("style", "display:block");

		// and send them the deck
		n.channel.send(cardtable.connected());
	};
} else {
	n = new DataChannel(url_params.get("webrtc_offer"))
	cardtable = new CardTable(num_cards, is_dealer);

	n.offer_ready = (answer) => {
		let d = document.getElementById("webrtc-answer");
		d.value = answer;

		let b = document.getElementById("copy-answer");
		b.setAttribute("style", "visibility:block");
	};

	n.onopen = () => {
		// when the other side connects, hide the webrtc gui
		document.getElementById("webrtc-ui").setAttribute("style", "display:none");
		document.getElementById("game-ui").setAttribute("style", "display:block");
	};
}

n.onmessage = (m) => {
	console.log("RX", m.substr(0,64));

	let resp = cardtable.command(m);
	if (resp)
	{
		console.log("TX", resp.substr(0,64));
		n.channel.send(resp);
	}

	display_update();
};

</script>


<form id="webrtc-ui" onsubmit="return false">
<div id="webrtc-link"></div>
<input id="webrtc-answer" />
<input type="button" value="Copy Answer" id="copy-answer" style="visibility:hidden" onclick="
	let copy_field = document.getElementById('webrtc-answer');
	copy_field.select();
	copy_field.setSelectionRange(0,99999);
	document.execCommand('copy');
" />
</form>

<div id="game-ui" style="display:none">
<form id="ui" onsubmit="return false">

<input type="button" value="Draw a card (facedown)" onclick="n.channel.send('draw')" />
<input type="button" value="Draw a card (faceup)" onclick="n.channel.send('draw=faceup')" />

<input type="button" value="Deal a card (facedown)" onclick="
	n.channel.send(cardtable.command('draw'));
	display_update();
" />

<input type="button" value="Deal a card (faceup)" onclick="
	n.channel.send(cardtable.command('draw=faceup'));
	display_update();
" />

</form>

<table>
<tr>
<th>Deck</th>
<th>Table</th>
<th>Dealer</th>
<th>Player</th>
<th>Discard</th>
</tr>
<tr>
<td><div id="deck" style="font-size:32px"></div></td>
<td><div id="table" style="font-size:64px"></div></td>
<td><div id="dealer" style="font-size:64px"></div></td>
<td><div id="player" style="font-size:64px"></div></td>
<td><div id="discard" style="font-size:32px"></div></td>
</tr>
</table>
</div>

</body>
</html>
