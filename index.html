<html>
<head>
<script src="util.js"></script>
<script src="sha256.js"></script>
<script src="sra.js"></script>
<script src="cards.js"></script>
<script src="webrtc.js"></script>
</head>
<body>
<script>
let cards = "ðŸ‚¡ðŸ‚¢ðŸ‚£ðŸ‚¤ðŸ‚¥ðŸ‚¦ðŸ‚§ðŸ‚¨ðŸ‚©ðŸ‚ªðŸ‚«ðŸ‚¬ðŸ‚­ðŸ‚®ðŸ‚±ðŸ‚²ðŸ‚³ðŸ‚´ðŸ‚µðŸ‚¶ðŸ‚·ðŸ‚¸ðŸ‚¹ðŸ‚ºðŸ‚»ðŸ‚¼ðŸ‚½ðŸ‚¾ðŸƒðŸƒ‚ðŸƒƒðŸƒ„ðŸƒ…ðŸƒ†ðŸƒ‡ðŸƒˆðŸƒ‰ðŸƒŠðŸƒ‹ðŸƒŒðŸƒðŸƒŽðŸƒ‘ðŸƒ’ðŸƒ“ðŸƒ”ðŸƒ•ðŸƒ–ðŸƒ—ðŸƒ˜ðŸƒ™ðŸƒšðŸƒ›ðŸƒœðŸƒðŸƒž";

function add_card(id, new_card)
{
	let suite = Math.floor(new_card / 12);
	let card = document.createElement('div');
	card.setAttribute('id', 'card-' + new_card);
	if (suite == 1 || suite == 2)
		card.setAttribute('style', 'color:red');
	else
		card.setAttribute('style', 'color:black');
	card.innerHTML = cards.substr(new_card*2, 2);
	document.querySelector(id).appendChild(card);
}

// if the URL does not have a webrtc offer, then we are
// the dealer and can setup the data chanell

const url_params = new URLSearchParams(window.location.search);
const is_webrtc_initiator = !url_params.has("webrtc_offer");

if (is_webrtc_initiator)
{
	d = new DeckDealer(52);
	n = new DataChannel();
	n.offer_ready = (offer) => {
		document.getElementById("webrtc-link").innerHTML = "<a href=" + document.location + "?webrtc_offer=" + offer + ">Link for other player</a>";

		let answer = document.getElementById('webrtc-answer');

		answer.addEventListener("keyup", event => {
			if(event.key !== "Enter")
				return;
			n.accept(answer.value);
			event.preventDefault();
		});
	};

	n.onopen = () => {
		// when the other side connects, send them the deck
		let deck = d.export()
			.map(c => bigint2hex(c.encrypted,80) + "|" + bigint2hex(c.hash,32))
			.join(',');
		n.channel.send("deck="+deck);
	};

	n.onmessage = (m) => {
		console.log("message", m);
		let [cmd,data] = m.split('=');
		if (cmd == "deck")
		{
			let player_deck = data.split(',').map(c => {
				let [enc,hash] = c.split('|');
				enc = BigInt("0x" + enc);
				hash = BigInt("0x" + hash);
				return {
					encrypted: enc,
					hash: hash,
				}
			});

			d.import(player_deck);
		}
	};
} else {
	n = new DataChannel(url_params.get("webrtc_offer"))
	n.offer_ready = (answer) => {
		let d = document.getElementById("webrtc-answer");
		d.value = answer;

		let b = document.getElementById("copy-answer");
		b.setAttribute("style", "visibility:block");
	};

	n.onmessage = (m) => {
		console.log("message", m);
		let [cmd,data] = m.split('=');
		if (cmd == "deck")
		{
			let dealer_deck = data.split(',').map(c => {
				let [enc,hash] = c.split('|');
				enc = BigInt("0x" + enc);
				hash = BigInt("0x" + hash);
				return {
					encrypted: enc,
					hash: hash,
				}
			});

			p = new DeckPlayer(dealer_deck);
			let player_deck = p.export();
			let msg = player_deck.map(c => {
				let enc = bigint2hex(c.encrypted, 80);
				let hash = bigint2hex(c.hash, 32);
				return enc + "|" + hash;
			}).join(',');

			n.channel.send("deck=" + msg);
		}
	};
}
</script>

<div id="webrtc-link"></div>

<form id="ui" onsubmit="return false">
<input id="webrtc-answer" />
<input type="button" value="Copy Answer" id="copy-answer" style="visibility:hidden" onclick="
	let copy_field = document.getElementById('webrtc-answer');
	copy_field.select();
	copy_field.setSelectionRange(0,99999);
	document.execCommand('copy');
" />
<input type="button" value="Shuffle" onclick="
	console.log('Creating dealer');
	d = new DeckDealer(52);

	console.log('Creating player');
	p = new DeckPlayer(d.export());

	console.log('Importing shuffled deck');
	d.import(p.export());

	document.querySelector('#player').innerHTML='';
	document.querySelector('#dealer').innerHTML='';
"/>

<input type="button" value="Deal to dealer" onclick="
	let new_card = d.receive(p.deal());
	if (new_card)
		add_card('#dealer', Number(new_card));
" />

<input type="button" value="Dealer draw" onclick="
	let new_card = d.receive(p.drawn(d.draw()));
	if (new_card)
		add_card('#dealer', Number(new_card));
" />


<input type="button" value="Deal to player" onclick="
	let new_card = p.receive(d.deal());
	if (new_card)
		add_card('#player', Number(new_card));
" />

<input type="button" value="Player draw" onclick="
	let new_card = p.receive(d.drawn(p.draw()));
	if (new_card)
		add_card('#player', Number(new_card));
" />
</form>

<table>
<tr>
<td>
<div id="dealer" style="font-size:64px"></div>
</td>
<td>
<div id="player" style="font-size:64px"></div>
</td>
</tr>
</table>

</body>
</html>
