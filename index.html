<html>
<head>
<script src="util.js"></script>
<script src="sha256.js"></script>
<script src="sra.js"></script>
<script src="cards.js"></script>
<script src="cardtable.js"></script>
<script src="webrtc.js"></script>
</head>
<body>
<script>
const cards =
"ðŸ‚¡ðŸ‚¢ðŸ‚£ðŸ‚¤ðŸ‚¥ðŸ‚¦ðŸ‚§ðŸ‚¨ðŸ‚©ðŸ‚ªðŸ‚«ðŸ‚­ðŸ‚®"+
"ðŸ‚±ðŸ‚²ðŸ‚³ðŸ‚´ðŸ‚µðŸ‚¶ðŸ‚·ðŸ‚¸ðŸ‚¹ðŸ‚ºðŸ‚»ðŸ‚½ðŸ‚¾"+
"ðŸƒðŸƒ‚ðŸƒƒðŸƒ„ðŸƒ…ðŸƒ†ðŸƒ‡ðŸƒˆðŸƒ‰ðŸƒŠðŸƒ‹ðŸƒðŸƒŽ"+
"ðŸƒ‘ðŸƒ’ðŸƒ“ðŸƒ”ðŸƒ•ðŸƒ–ðŸƒ—ðŸƒ˜ðŸƒ™ðŸƒšðŸƒ›ðŸƒðŸƒž";
const num_cards = cards.length/2; // two-byte characters
let cardtable = null;

function add_card(id, new_card)
{
	let suite = Math.floor(new_card / 12);
	let card = document.createElement('div');
	card.setAttribute('id', 'card-' + new_card);
	if (suite == 1 || suite == 2)
		card.setAttribute('style', 'color:red');
	else
		card.setAttribute('style', 'color:black');
	card.innerHTML = cards.substr(new_card*2, 2);
	document.querySelector(id).appendChild(card);
}

// if the URL does not have a webrtc offer, then we are
// the dealer and can setup the data chanell

const url_params = new URLSearchParams(window.location.search);
const is_webrtc_initiator = !url_params.has("webrtc_offer");

if (is_webrtc_initiator)
{
	n = new DataChannel();
	cardtable = new CardTable(num_cards, true);

	n.offer_ready = (offer) => {
		document.getElementById("webrtc-link").innerHTML = "<a href=" + document.location + "?webrtc_offer=" + offer + ">Link for other player</a>";

		let answer = document.getElementById('webrtc-answer');

		answer.addEventListener("keyup", event => {
			if(event.key !== "Enter")
				return;
			n.accept(answer.value);
			event.preventDefault();
		});
	};

	n.onopen = () => {
		// when the other side connects, send them the deck
		n.channel.send(cardtable.command("shuffle"));
	};
} else {
	n = new DataChannel(url_params.get("webrtc_offer"))
	cardtable = new CardTable(num_cards, false);

	n.offer_ready = (answer) => {
		let d = document.getElementById("webrtc-answer");
		d.value = answer;

		let b = document.getElementById("copy-answer");
		b.setAttribute("style", "visibility:block");
	};
}

n.onmessage = (m) => {
	console.log("RX", m.substr(0,64));

	let resp = cardtable.command(m);
	if (!resp)
		return;

	console.log("TX", resp.substr(0,64));
	n.channel.send(resp);
};

</script>

<div id="webrtc-link"></div>

<form id="ui" onsubmit="return false">
<input id="webrtc-answer" />
<input type="button" value="Copy Answer" id="copy-answer" style="visibility:hidden" onclick="
	let copy_field = document.getElementById('webrtc-answer');
	copy_field.select();
	copy_field.setSelectionRange(0,99999);
	document.execCommand('copy');
" />
<input type="button" value="Shuffle" onclick="
	console.log('Creating dealer');
	d = new DeckDealer(52);

	console.log('Creating player');
	p = new DeckPlayer(d.export());

	console.log('Importing shuffled deck');
	d.import(p.export());

	document.querySelector('#player').innerHTML='';
	document.querySelector('#dealer').innerHTML='';
"/>

<input type="button" value="Deal to dealer" onclick="
	let new_card = d.receive(p.deal());
	if (new_card)
		add_card('#dealer', Number(new_card));
" />

<input type="button" value="Dealer draw" onclick="
	let new_card = d.receive(p.drawn(d.draw()));
	if (new_card)
		add_card('#dealer', Number(new_card));
" />


<input type="button" value="Deal to player" onclick="
	let new_card = p.receive(d.deal());
	if (new_card)
		add_card('#player', Number(new_card));
" />

<input type="button" value="Player draw" onclick="
	let new_card = p.receive(d.drawn(p.draw()));
	if (new_card)
		add_card('#player', Number(new_card));
" />
</form>

<table>
<tr>
<td>
<div id="dealer" style="font-size:64px"></div>
</td>
<td>
<div id="player" style="font-size:64px"></div>
</td>
</tr>
</table>

</body>
</html>
